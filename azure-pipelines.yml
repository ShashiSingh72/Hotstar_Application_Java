trigger: none

resources:
- repo: self

variables:
  imageName: java-app
  tag: latest
  containerName: java-app-container

stages:
- stage: BuildAndDeploy
  displayName: Build Image and Deploy Container
  jobs:
  - job: BuildDeploy
    displayName: Build & Run Docker Container
    pool: TodoAgent   # ✅ SELF-HOSTED AGENT

    steps:
    # 1️⃣ Build Docker Image
    - task: Docker@2
      displayName: Build Docker Image
      inputs:
        command: build
        repository: $(imageName)                 # ❗ sirf image name
        dockerfile: $(Build.SourcesDirectory)/Dockerfile
        tags: |
          $(tag)

    # 2️⃣ Remove old container if exists
    - task: PowerShell@2
      displayName: Remove old container
      inputs:
        targetType: inline
        script: |
          docker rm -f $(containerName) 2>$null
          echo "Old container removed (if existed)"

    # 3️⃣ Run container from image (DEPLOY)
    - task: PowerShell@2
      displayName: Run Docker Container
      inputs:
        targetType: inline
        script: |
          docker run -d `
            --name $(containerName) `
            -p 8080:8080 `
            $(imageName):$(tag)
